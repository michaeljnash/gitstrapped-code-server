<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="__CSP__" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Codestrap</title>
  <style>
    :root{
      --bg: var(--vscode-sideBar-background);
      --fg: var(--vscode-foreground);
      --muted: var(--vscode-descriptionForeground);
      --btn: var(--vscode-button-background);
      --btnText: var(--vscode-button-foreground);
      --border: var(--vscode-panel-border);
      --input: var(--vscode-input-background);
      --eyeGrey: #8a8a8a;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body{ margin:0; padding:0; overflow:hidden; font-family: var(--vscode-font-family); color: var(--fg); background: var(--bg); }
    #app{ height:100vh; overflow:auto; padding:12px; }

    h3{ margin:12px 0 8px; font-size:13px; }
    .section{ border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px; }
    label{ font-size:12px; display:block; margin:6px 0 2px; color: var(--muted); }
    input[type="text"], input[type="password"], select{
      width:100%; max-width:100%; display:block; padding:8px 10px; background:var(--input); color:var(--fg);
      border:1px solid var(--border); border-radius:8px;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .toprow{ display:flex; gap:8px; margin-bottom:8px; justify-content:center; flex-direction: row; }
    .toprow button{ min-width:120px; }
    @media (max-width: 400px){
      .toprow{ flex-direction: column; }
      .toprow button{ width:100%; }
    }

    button{
      border:0; border-radius:8px; background:var(--btn); color: var(--btnText);
      padding:6px 12px; cursor:pointer; position:relative;
    }

    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    .loading{ color: transparent !important; }
    .loading::before{
      content:"";
      position:absolute; left:50%; top:50%;
      margin-left:-8px; margin-top:-8px;
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.95);
      animation: spin 0.8s linear infinite;
    }

    .input-with-eye{ position:relative; }
    .eye-btn{
      position:absolute; top:50%; right:8px; transform:translateY(-50%);
      display:inline-flex; align-items:center; justify-content:center;
      width:22px; height:22px; background:transparent; border:0; cursor:pointer; padding:0; margin:0;
      color: var(--eyeGrey) !important; -webkit-text-fill-color: var(--eyeGrey); outline: none;
    }
    .eye-btn svg { width:16px; height:16px; stroke: currentColor; fill: none; }
    .pad-right-eye{ padding-right:44px; }

    .small{ font-size:11px; color: var(--muted); }
    .center-row{ justify-content:center; }
  </style>
</head>
<body>
  <div id="app">
    <div class="toprow">
      <button id="btn-docs">Docs</button>
      <button id="btn-cli">CLI</button>
      <button id="reboot">Reboot</button>
    </div>

    <div class="section" id="sec-passwd">
      <h3>Change password</h3>

      <label>New password</label>
      <div class="input-with-eye">
        <input id="pw" type="password" class="pad-right-eye" placeholder="at least 8 characters" />
        <button class="eye-btn" type="button" id="pw-eye" title="Show/Hide" aria-label="Show/Hide">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>

      <label style="margin-top:6px;">Confirm password</label>
      <div class="input-with-eye">
        <input id="pw2" type="password" class="pad-right-eye" placeholder="re-enter password" />
        <button class="eye-btn" type="button" id="pw2-eye" title="Show/Hide" aria-label="Show/Hide">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>

      <div class="row center-row" style="margin-top:8px;">
        <button id="pw-run">Change</button>
      </div>
    </div>

    <div class="section" id="sec-config">
      <h3>Bootstrap config</h3>
      <div class="row"><label><input type="checkbox" id="cfg-settings" checked /> Merge <code>settings.json</code></label></div>
      <div class="row"><label><input type="checkbox" id="cfg-keyb" checked /> Merge <code>keybindings.json</code></label></div>
      <div class="row"><label><input type="checkbox" id="cfg-tasks" checked /> Merge <code>tasks.json</code></label></div>
      <div class="row"><label><input type="checkbox" id="cfg-ext" checked /> Merge <code>extensions.json</code></label></div>
      <div class="row center-row" style="margin-top:8px;">
        <button id="cfg-run">Merge</button>
        <span class="small">Merge codestrap config files into user config files</span>
      </div>
    </div>

    <div class="section" id="sec-ext">
      <h3>Manage extensions</h3>
      <label>Uninstall scope</label>
      <select id="ext-un">
        <option value="">(none)</option>
        <option value="missing">missing (cleanup)</option>
        <option value="all">all (remove everything)</option>
      </select>
      <label style="margin-top:6px;">Install scope</label>
      <select id="ext-in">
        <option value="">(none)</option>
        <option value="missing">missing</option>
        <option value="all">all (update to latest)</option>
      </select>
      <div class="row center-row" style="margin-top:8px;">
        <button id="ext-run">Apply</button>
      </div>
    </div>

    <div class="section" id="sec-github">
      <h3>Bootstrap GitHub</h3>
      <div class="row"><label><input type="checkbox" id="gh-auto" /> Use <code>--auto</code> (env vars)</label></div>
      <div id="gh-fields">
        <label>Username</label>
        <input id="gh-user" type="text" placeholder="GITHUB_USERNAME" />
        <label>Token (classic)</label>
        <div class="input-with-eye">
          <input id="gh-token" type="password" class="pad-right-eye" placeholder="GITHUB_TOKEN" />
          <button class="eye-btn" type="button" id="gh-token-eye" title="Show/Hide" aria-label="Show/Hide">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <label>Name (blank=use GitHub username)</label>
        <input id="git-name" type="text" placeholder="GIT_NAME" />
        <label>Email (blank=use GitHub account email)</label>
        <input id="git-email" type="text" placeholder="GIT_EMAIL" />
        <label>Repos (comma-separated owner/repo or owner/repo#branch or URLs)</label>
        <input id="gh-repos" type="text" placeholder="GITHUB_REPOS" />
        <div class="row"><label><input type="checkbox" id="gh-pull" checked /> Pull existing repos (fast-forward)</label></div>
      </div>
      <div class="row center-row" style="margin-top:8px;">
        <button id="gh-run">Run</button>
      </div>
    </div>
  </div><!-- /#app -->

  <script nonce="__NONCE__">
    const vscode = acquireVsCodeApi();
    const INITIAL = __INITIAL__;

    // helpers
    const $ = (id) => document.getElementById(id);
    const togglePw = (inputId) => { const el = $(inputId); el.type = (el.type === 'password') ? 'text' : 'password'; };

    // --- Top buttons ---
    $("btn-docs").onclick = () => vscode.postMessage({ type:"open:docs" });
    $("btn-cli").onclick  = () => vscode.postMessage({ type:"open:cli" });

    // Reboot with spinner-only; proper centered spin
    (function setupReboot(){
      const btn = $("reboot");
      btn.onclick = () => {
        btn.classList.add("loading");
        btn.disabled = true;
        vscode.postMessage({ type:"reboot" });
      };
    })();

    // password toggles
    $("pw-eye").onclick  = () => togglePw("pw");
    $("pw2-eye").onclick = () => togglePw("pw2");
    $("gh-token-eye").onclick = () => togglePw("gh-token");

    // prefill GitHub fields from env if provided
    (function prefill(){
      if (INITIAL.GITHUB_USERNAME) $("gh-user").value = INITIAL.GITHUB_USERNAME;
      if (INITIAL.GITHUB_TOKEN)    $("gh-token").value = INITIAL.GITHUB_TOKEN;
      if (INITIAL.GIT_NAME)        $("git-name").value = INITIAL.GIT_NAME;
      if (INITIAL.GIT_EMAIL)       $("git-email").value = INITIAL.GIT_EMAIL;
      if (INITIAL.GITHUB_REPOS)    $("gh-repos").value = INITIAL.GITHUB_REPOS;

      if (INITIAL.GITHUB_PULL) {
        const v = String(INITIAL.GITHUB_PULL).trim().toLowerCase();
        $("gh-pull").checked = ['1','y','yes','t','true','on'].includes(v);
      }
    })();

    // actions
    $("pw-run").onclick = () => {
      const a = $("pw").value || "";
      const b = $("pw2").value || "";
      if (a.length < 8) { vscode.window.showErrorMessage('Password must be at least 8 characters.'); return; }
      if (a !== b)      { vscode.window.showErrorMessage('Passwords do not match.'); return; }
      vscode.postMessage({ type:"passwd:set", password: a, confirm: b });
    };

    $("cfg-run").onclick = () => {
      vscode.postMessage({
        type:"config:run",
        settings: $("cfg-settings").checked,
        keybindings: $("cfg-keyb").checked,
        tasks: $("cfg-tasks").checked,
        extensions: $("cfg-ext").checked
      });
    };

    $("ext-run").onclick = () => {
      vscode.postMessage({
        type:"ext:apply",
        uninstall: $("ext-un").value || "",
        install: $("ext-in").value || ""
      });
    };

    $("gh-auto").onchange = () => {
      $("gh-fields").style.display = $("gh-auto").checked ? "none" : "block";
    };
    $("gh-run").onclick = () => {
      const auto = $("gh-auto").checked;
      vscode.postMessage({
        type: "github:run",
        auto,
        username: auto ? "" : $("gh-user").value,
        token:    auto ? "" : $("gh-token").value,
        name:     auto ? "" : $("git-name").value,
        email:    auto ? "" : $("git-email").value,
        repos:    auto ? "" : $("gh-repos").value,
        pull:     auto ? undefined : $("gh-pull").checked
      });
    };
  </script>
</body>
</html>
